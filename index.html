<!--
  Studypedia Dynamic Web Application (Revised Version 8)

  This version fixes the "document.createElement is not a function" error
  by renaming a variable in the Firestore loop. The variable "document"
  was incorrectly shadowing the global Document Object Model, causing
  the error. Renaming it to "docSnapshot" resolves the conflict.

  - Fully responsive layout using Tailwind CSS.
  - Modals for user authentication (Login/Signup) and downloads.
  - Dynamic content loading from Firestore.
  - Download options based on payment, file uploads, or watching ads.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Studypedia - Free Notes for Students in Uganda</title>
  <meta name="description" content="Access free academic notes for Certificate, Diploma, and Bachelors students in Uganda. Study guides and resources available for everyone.">

  <!-- Inter font for a clean, modern look -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Use Inter font for a clean, modern look */
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-slate-900 text-gray-100 min-h-screen">

  <!-- Main layout container -->
  <div class="flex flex-col lg:flex-row min-h-screen">

    <!-- Left Sidebar/Menu -->
    <aside class="bg-slate-800 p-6 lg:p-8 lg:w-64 w-full flex-shrink-0 flex flex-col">
      <!-- Logo or Site Title -->
      <div class="mb-8">
        <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-sky-500">
          Studypedia
        </h2>
      </div>

      <!-- User Authentication UI -->
      <div id="auth-ui" class="space-y-4 mb-8">
        <button id="auth-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:bg-indigo-500 transition-colors">
          Loading...
        </button>
        <p id="user-id-display" class="text-sm text-gray-400 text-center truncate hidden"></p>
      </div>

      <!-- Navigation Menu (dynamic content) -->
      <nav id="academic-nav" class="space-y-4 flex-grow">
        <!-- Links will be dynamically inserted here -->
      </nav>

      <!-- AD SPACE IN SIDEBAR: Placeholder for an ad. -->
      <div class="mt-auto bg-gray-800 text-gray-400 p-4 rounded-xl flex items-center justify-center border border-gray-700">
        <p class="text-sm font-semibold text-center">Google AdSense - Sidebar Ad</p>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-grow p-6 lg:p-12 overflow-y-auto">
      <!-- Welcome Section -->
      <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl mb-8">
        <h1 class="text-4xl md:text-5xl font-extrabold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-sky-500">
          Welcome, students of Uganda!
        </h1>
        <p class="text-lg md:text-xl text-gray-300 leading-relaxed">
          Find and share academic notes for your classes.
        </p>
      </div>
      <!-- Dynamically loaded academic sections will be inserted here -->
    </main>
  </div>
  
  <!-- Authentication Modal -->
  <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
    <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm">
      <div class="flex justify-between items-center mb-4">
        <h3 id="auth-title" class="text-2xl font-bold">Login</h3>
        <button id="close-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
      </div>
      <form id="auth-form" class="space-y-4">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-300">Email address</label>
          <input type="email" id="email" required class="mt-1 block w-full rounded-md bg-slate-700 border-gray-600 text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-300">Password</label>
          <input type="password" id="password" required class="mt-1 block w-full rounded-md bg-slate-700 border-gray-600 text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
        </div>
        <button type="submit" id="submit-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-500 transition-colors">Login</button>
      </form>
      <div class="mt-4 text-center">
        <button id="toggle-auth-btn" class="text-sm text-indigo-400 hover:text-indigo-300">
          Don't have an account? Sign Up
        </button>
      </div>
      <div id="modal-message-box" class="mt-4 text-center p-2 rounded-md hidden"></div>
    </div>
  </div>

  <!-- Download Modal -->
  <div id="download-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
    <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-lg">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold">Download Document</h3>
        <button id="close-download-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
      </div>

      <p class="text-gray-300 mb-6">Choose one of the following options to download this document:</p>

      <!-- Pay to Download Section -->
      <div class="bg-slate-700 p-6 rounded-lg mb-4">
        <h4 class="text-xl font-semibold text-indigo-400 mb-2">Option 1: Pay to Download</h4>
        <p class="text-gray-400 mb-4">Support Studypedia by paying for a monthly or yearly plan.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button id="pay-monthly-btn" class="bg-indigo-600 text-white py-3 px-6 rounded-md hover:bg-indigo-500 transition-colors">
            UGX 10,000 / Monthly
          </button>
          <button id="pay-yearly-btn" class="bg-indigo-600 text-white py-3 px-6 rounded-md hover:bg-indigo-500 transition-colors">
            UGX 50,000 / Yearly
          </button>
        </div>
        <div id="payment-details" class="mt-4 text-center p-4 bg-slate-600 rounded-md hidden">
          <p class="font-bold">Please send money to:</p>
          <p class="text-lg font-mono text-white mt-2">+256756454646</p>
          <p class="font-bold">Name: KAIGWA AKRAM</p>
          <p class="text-sm text-gray-400 mt-2">After payment, a download link will be available after verification.</p>
        </div>
      </div>

      <!-- Upload Documents Section -->
      <div class="bg-slate-700 p-6 rounded-lg mb-4">
        <h4 class="text-xl font-semibold text-teal-400 mb-2">Option 2: Upload Documents</h4>
        <p class="text-gray-400 mb-4">Upload three of your own documents to get one free download.</p>
        <div class="flex items-center space-x-4">
          <input type="file" id="document-upload" multiple class="block w-full text-sm text-gray-500
            file:mr-4 file:py-2 file:px-4
            file:rounded-full file:border-0
            file:text-sm file:font-semibold
            file:bg-indigo-50 file:text-indigo-700
            hover:file:bg-indigo-100" />
          <button id="upload-btn" class="bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-500 transition-colors">
            Upload
          </button>
        </div>
        <p id="upload-count" class="text-sm text-gray-400 mt-2 hidden">
          Uploaded 0 of 3 documents.
        </p>
      </div>

      <!-- Watch Ads Section -->
      <div class="bg-slate-700 p-6 rounded-lg">
        <h4 class="text-xl font-semibold text-sky-400 mb-2">Option 3: Watch Ads</h4>
        <p class="text-gray-400 mb-4">Watch 10 ads to download a document for free.</p>
        <div class="flex items-center justify-between">
          <button id="watch-ad-btn" class="bg-sky-600 text-white py-3 px-6 rounded-md hover:bg-sky-500 transition-colors">
            Watch Ad (<span id="ad-counter">0</span> / 10)
          </button>
          <button id="download-link-ad" class="bg-green-600 text-white py-3 px-6 rounded-md hover:bg-green-500 transition-colors hidden">
            Download
          </button>
        </div>
      </div>
      
      <div id="download-message-box" class="mt-4 text-center p-2 rounded-md hidden"></div>
    </div>
  </div>

  <!-- Global Message Box -->
  <div id="global-message-box" class="fixed bottom-4 right-4 bg-gray-800 text-white p-4 rounded-lg shadow-xl hidden z-50"></div>


<!--
  Firebase and App Logic
-->
<script type="module">
  // Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
  import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  // State
  let isLoginMode = true;
  let currentDownloadSectionId = null;

  // --- Main App Initialization ---
  let app, auth, db;
  let isAuthReady = false;
  let isFirebaseConfigured = false;

  // Helper function to show messages in a dedicated global box
  const showMessage = (text, isError = false) => {
    const messageBox = document.getElementById('global-message-box');
    if (!messageBox) return;
    messageBox.textContent = text;
    messageBox.classList.remove('hidden', 'bg-red-900', 'bg-green-900');
    messageBox.classList.add('block', isError ? 'bg-red-900' : 'bg-green-900');
    setTimeout(() => {
      messageBox.classList.add('hidden');
    }, 5000);
  };

  // Function to show/hide the auth modal
  const toggleAuthModal = (show) => {
    const authModal = document.getElementById('auth-modal');
    if (show) {
      authModal.classList.remove('hidden');
      authModal.classList.add('flex');
    } else {
      authModal.classList.remove('flex');
      authModal.classList.add('hidden');
    }
  };

  // Function to show/hide the download modal
  const toggleDownloadModal = (show, sectionId = null) => {
    const downloadModal = document.getElementById('download-modal');
    const paymentDetails = document.getElementById('payment-details');
    if (show) {
      currentDownloadSectionId = sectionId;
      downloadModal.classList.remove('hidden');
      downloadModal.classList.add('flex');
    } else {
      currentDownloadSectionId = null;
      downloadModal.classList.remove('flex');
      downloadModal.classList.add('hidden');
      paymentDetails.classList.add('hidden');
    }
  };

  window.onload = async () => {
    try {
      // Get DOM elements after the window has loaded
      const authBtn = document.getElementById('auth-btn');
      const authForm = document.getElementById('auth-form');
      const authTitle = document.getElementById('auth-title');
      const submitBtn = document.getElementById('submit-btn');
      const toggleAuthBtn = document.getElementById('toggle-auth-btn');
      const academicNav = document.getElementById('academic-nav');
      const mainContent = document.getElementById('main-content');
      const userIdDisplay = document.getElementById('user-id-display');
      const closeAuthModalBtn = document.getElementById('close-modal-btn');
      
      // Download Modal Elements
      const closeDownloadModalBtn = document.getElementById('close-download-modal-btn');
      const payMonthlyBtn = document.getElementById('pay-monthly-btn');
      const payYearlyBtn = document.getElementById('pay-yearly-btn');
      const paymentDetails = document.getElementById('payment-details');
      const uploadBtn = document.getElementById('upload-btn');
      const uploadCountEl = document.getElementById('upload-count');
      const documentUpload = document.getElementById('document-upload');
      const watchAdBtn = document.getElementById('watch-ad-btn');
      const adCounterEl = document.getElementById('ad-counter');
      const downloadLinkAd = document.getElementById('download-link-ad');
      const downloadMessageBox = document.getElementById('download-message-box');

      // Check for Firebase configuration and initialize
      const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
      if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        isFirebaseConfigured = true;
        showMessage("Firebase successfully initialized.", false);

        // Sign in with the custom token if it exists
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        if (initialAuthToken && auth) {
          try {
            await signInWithCustomToken(auth, initialAuthToken);
            showMessage('Automatic login successful!', false);
          } catch (error) {
            console.error("Error signing in with custom token:", error);
            showMessage("Automatic login failed. Please log in manually.", true);
          }
        }
      } else {
        console.warn("Firebase config is not available. Running in a limited mode.");
        showMessage("Firebase config not found. Authentication and data features are disabled.", true);
        authBtn.textContent = 'Auth Unavailable';
        authBtn.disabled = true;
        authBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }

      // Add a single, reliable click listener to the auth button
      authBtn.addEventListener('click', async () => {
        if (!isAuthReady) {
          showMessage('Authentication is still loading. Please wait a moment.', true);
          return;
        }
        if (auth.currentUser) {
          // User is logged in, so log them out
          try {
            await signOut(auth);
            showMessage('Successfully logged out.', false);
          } catch (error) {
            showMessage(`Logout failed: ${error.message}`, true);
          }
        } else {
          // User is not logged in, so show the auth modal
          toggleAuthModal(true);
        }
      });

      // Handle Auth Form Submission
      authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const modalMessageBox = document.getElementById('modal-message-box');
        modalMessageBox.textContent = 'Processing...';
        modalMessageBox.classList.remove('hidden');

        try {
          if (isLoginMode) {
            await signInWithEmailAndPassword(auth, email, password);
            showMessage('Login successful!', false);
          } else {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            await setDoc(doc(db, `artifacts/${__app_id}/users/${userCredential.user.uid}/user_data`, 'profile'), {
              uploaded_docs_count: 0,
              downloaded_docs_count: 0,
              ad_views: 0
            });
            showMessage('Signup successful!', false);
          }
          toggleAuthModal(false);
          authForm.reset();
        } catch (error) {
          modalMessageBox.textContent = `Error: ${error.message}`;
          modalMessageBox.classList.add('bg-red-900', 'text-white');
        }
      });

      // Toggle between Login and Signup modes
      toggleAuthBtn.addEventListener('click', () => {
        isLoginMode = !isLoginMode;
        authTitle.textContent = isLoginMode ? 'Login' : 'Signup';
        submitBtn.textContent = isLoginMode ? 'Login' : 'Signup';
        toggleAuthBtn.textContent = isLoginMode ? "Don't have an account? Sign Up" : "Already have an account? Login";
      });

      // Close Modal Buttons
      closeAuthModalBtn.addEventListener('click', () => toggleAuthModal(false));
      closeDownloadModalBtn.addEventListener('click', () => toggleDownloadModal(false));

      // Function to dynamically load content from Firestore
      async function loadAcademicContent(user) {
        if (!isFirebaseConfigured || !user) {
           console.log("Firebase not configured or user not logged in. Displaying fallback content.");
           mainContent.innerHTML = `
            <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl mb-8">
              <h1 class="text-4xl md:text-5xl font-extrabold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-sky-500">
                Welcome, students of Uganda!
              </h1>
              <p class="text-lg md:text-xl text-gray-300 leading-relaxed">
                Find and share academic notes for your classes.
              </p>
            </div>
            <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl mb-8 text-center text-gray-400">
              <p class="text-xl">Authentication and data features are unavailable. Please check your configuration.</p>
            </div>
          `;
          return;
        }

        try {
          // Add a default document to the public collection to ensure a valid query.
          const publicCollectionRef = collection(db, `artifacts/${__app_id}/public/data/academic_sections`);
          await setDoc(doc(publicCollectionRef, 'default-notes'), {
            title: "General Study Notes",
            content: "Welcome to your study notes! This is a default document. You will be able to upload more documents here."
          }, { merge: true });

          const sectionsCollection = collection(db, `artifacts/${__app_id}/public/data/academic_sections`);
          const sectionsSnapshot = await getDocs(sectionsCollection);
          
          academicNav.innerHTML = '';
          mainContent.innerHTML = `
            <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl mb-8">
              <h1 class="text-4xl md:text-5xl font-extrabold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-sky-500">
                Welcome, students of Uganda!
              </h1>
              <p class="text-lg md:text-xl text-gray-300 leading-relaxed">
                Find and share academic notes for your classes.
              </p>
            </div>
          `;
          
          sectionsSnapshot.forEach((docSnapshot) => {
            const data = docSnapshot.data();
            const sectionId = docSnapshot.id;
            
            const navItem = document.createElement('li');
            navItem.innerHTML = `<a href="#${sectionId}" class="block p-3 rounded-lg hover:bg-slate-700 transition-colors duration-200">
                                   ${data.title}
                                </a>`;
            academicNav.appendChild(navItem);

            const sectionEl = document.createElement('section');
            sectionEl.id = sectionId;
            sectionEl.classList.add('bg-slate-800', 'p-8', 'rounded-2xl', 'shadow-2xl', 'mb-8');
            sectionEl.innerHTML = `
              <h2 class="text-3xl md:text-4xl font-bold mb-4 text-teal-400">
                ${data.title}
              </h2>
              <p class="text-lg text-gray-300 leading-relaxed">
                ${data.content}
              </p>
              <button class="mt-4 px-6 py-3 bg-green-600 text-white font-semibold rounded-full shadow-lg hover:bg-green-500 transition-colors download-btn">
                Download
              </button>
            `;
            mainContent.appendChild(sectionEl);
          });
          
          document.querySelectorAll('.download-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const sectionId = e.target.closest('section').id;
              toggleDownloadModal(true, sectionId);
            });
          });
          
        } catch (error) {
          console.error("Error loading academic content: ", error);
          showMessage("Error loading content. Check your Firebase setup.", true);
        }
      }

      // --- Download Modal Logic ---
      let adCount = 0;
      payMonthlyBtn.addEventListener('click', () => {
        paymentDetails.classList.remove('hidden');
        showMessage('You selected a monthly plan. Follow the instructions to complete payment.', false);
      });
      
      payYearlyBtn.addEventListener('click', () => {
        paymentDetails.classList.remove('hidden');
        showMessage('You selected a yearly plan. Follow the instructions to complete payment.', false);
      });

      uploadBtn.addEventListener('click', async () => {
        const fileCount = documentUpload.files.length;
        if (fileCount >= 3) {
          showMessage('Upload successful! You can now download.', false);
          console.log(`User uploaded ${fileCount} files for document: ${currentDownloadSectionId}`);
        } else {
          showMessage(`Please upload at least 3 documents. You have uploaded ${fileCount}.`, true);
        }
      });
      
      documentUpload.addEventListener('change', () => {
        uploadCountEl.textContent = `Uploaded ${documentUpload.files.length} of 3 documents.`;
        uploadCountEl.classList.remove('hidden');
      });

      watchAdBtn.addEventListener('click', () => {
        if (adCount < 10) {
          adCount++;
          adCounterEl.textContent = adCount;
          showMessage(`Ad ${adCount} of 10 viewed. Keep going!`, false);
          if (adCount === 10) {
            showMessage('You have watched all 10 ads! The download button is now available.', false);
            downloadLinkAd.classList.remove('hidden');
            watchAdBtn.classList.add('hidden');
          }
        }
      });

      downloadLinkAd.addEventListener('click', () => {
        showMessage('Download is ready!', false);
        // Simulate download
        setTimeout(() => {
          console.log(`User watched 10 ads for document: ${currentDownloadSectionId}`);
          toggleDownloadModal(false);
          adCount = 0;
          adCounterEl.textContent = adCount;
          downloadLinkAd.classList.add('hidden');
          watchAdBtn.classList.remove('hidden');
        }, 1000);
      });
      
      // Handle Authentication State Changes
      if (isFirebaseConfigured) {
        onAuthStateChanged(auth, async (user) => {
          isAuthReady = true;
          authBtn.textContent = user ? 'Logout' : 'Login / Signup';
          userIdDisplay.textContent = user ? `User ID: ${user.uid}` : '';
          userIdDisplay.classList.toggle('hidden', !user);

          await loadAcademicContent(user);
        });
      } else {
        isAuthReady = true;
        await loadAcademicContent(null);
      }

    } catch (error) {
      console.error("Failed to initialize app:", error);
      showMessage("Failed to initialize app. Please check console for errors.", true);
    }
  };
</script>
</body>
</html>





